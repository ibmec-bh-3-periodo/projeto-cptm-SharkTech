<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minha Conta - CPTM</title>
  <link rel="stylesheet" href="./assets/css/tela-saldo.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
  <header class="header">
    <div class="top-row">
      <a class="link-back" href="home.html"><button class="back-button">←</button></a>
      <span class="title">CPTM</span>
      <img src="./assets/img/Logo cptm.png" alt="Logo CPTM" class="logo">
    </div>
    <div class="minha-conta"><h3>Minha Conta</h3></div>
  </header>

  <main class="container">
    <section class="saldo-box">
      <p class="sub">Saldo atual</p>
      <div class="saldo">
        <span id="valor-saldo">R$ 0,00</span>
        <button id="toggle-saldo" aria-label="Alternar visibilidade do saldo">
          <img id="icone-olho" src="./assets/img/eye-off.svg" alt="Ocultar saldo">
        </button>
      </div>
      <button class="adicionar-saldo" id="btn-adicionar">ADICIONAR SALDO</button>
    </section>

    <section class="acoes">
      <div class="card">
        <div class="info">
          <h3>Histórico</h3>
          <p>Acompanhe seus gastos de forma fácil e rápida.</p>
        </div>
        <img src="./assets/img/history-icon.svg" class="icon" alt="Ícone Histórico">
      </div>

      <div class="card">
        <div class="info">
          <h3>Gerar Bilhetes</h3>
          <p>Escolha o trajeto, pague pelo app e embarque com agilidade.</p>
        </div>
        <img src="./assets/img/tickets-icon.svg" class="icon" alt="Ícone Bilhete">
      </div>

      <div class="card">
        <div class="info">
          <h3>Carteira</h3>
          <p>Veja um bilhete já emitido disponível para utilização.</p>
        </div>
        <img src="./assets/img/wallet-icon.svg" class="icon" alt="Ícone Carteira">
      </div>
    </section>

    <a class="ajuda" href="#">
      <img src="./assets/img/help-icon.svg" alt="" class="help-icon"> CENTRAL DE AJUDA
    </a>
  </main>

  <!-- Modal: overlay + conteúdo -->
  <div class="modal-overlay" id="modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="modal-titulo">
    <div class="modal" role="document">
      <button class="modal-close" id="fechar-modal" aria-label="Fechar">×</button>
      <h3 id="modal-titulo">Adicionar Saldo</h3>

      <input type="text" id="valorInput" class="valor-input" placeholder="Digite o valor (R$)" inputmode="decimal" autocomplete="off">

      <div class="botoes-rapidos">
        <button type="button" data-add="2">+2</button>
        <button type="button" data-add="5">+5</button>
        <button type="button" data-add="10">+10</button>
        <button type="button" data-add="20">+20</button>
      </div>

      <p class="msg-erro" id="erro-valor" aria-live="polite"></p>

      <div class="modal-actions">
        <button class="cancelar" id="cancelar" type="button">Cancelar</button>
        <button class="confirmar" id="confirmar" type="button">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ===== Config (troque se precisar) =====
    const API_BASE = "http://localhost:3000";   // seu backend (opcional)
    const USER_ID  = 1;

    // ===== Utilitários BRL =====
    const BRL = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
    const fmt  = n => BRL.format(n);
    const parse = t => {
      if (!t) return NaN;
      return Number(String(t).trim()
        .replace(/[^\d,.-]/g,'')
        .replace(/\.(?=\d{3}(,|$))/g,'')
        .replace(',', '.'));
    };

    // ===== Seletores =====
    const valorSaldo = document.getElementById('valor-saldo');
    const iconeOlho  = document.getElementById('icone-olho');
    const toggleBtn  = document.getElementById('toggle-saldo');
    const btnAdd     = document.getElementById('btn-adicionar');

    const overlay    = document.getElementById('modal-overlay');
    const fecharModalBtn = document.getElementById('fechar-modal');
    const valorInput = document.getElementById('valorInput');
    const erroValor  = document.getElementById('erro-valor');
    const btnCancelar= document.getElementById('cancelar');
    const btnConfirm = document.getElementById('confirmar');
    const quickBtns  = document.querySelectorAll('.botoes-rapidos button');
    const toast      = document.getElementById('toast');

    // ===== Estado =====
    let saldoVisivel = true;
    let saldoAtual = 0;
    let modoOffline = false; // true quando API indisponível

    // ===== Toast =====
    function toastMsg(texto, tipo="ok") {
      const iconOK = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path stroke="currentColor" fill="none" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
      const iconER = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path stroke="currentColor" fill="none" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
      toast.innerHTML = (tipo==="erro"?iconER:iconOK) + texto;
      toast.classList.remove('erro','mostrar');
      if (tipo==="erro") toast.classList.add('erro');
      requestAnimationFrame(()=>toast.classList.add('mostrar'));
      clearTimeout(toast._t); toast._t = setTimeout(()=>toast.classList.remove('mostrar'), 2800);
    }

    // ===== Render do saldo =====
    function renderSaldo() {
      valorSaldo.textContent = saldoVisivel ? fmt(saldoAtual) : '••••';
      valorSaldo.dataset.valorReal = fmt(saldoAtual);
      iconeOlho.src = saldoVisivel ? './assets/img/eye-off.svg' : './assets/img/eye.svg';
      iconeOlho.alt = saldoVisivel ? 'Ocultar saldo' : 'Mostrar saldo';
    }

    // ===== API helpers (com fallback localStorage) =====
    const LS_KEY = 'saldoAtualReais';

    async function carregarSaldo() {
      try {
        const r = await fetch(`${API_BASE}/usuarios/${USER_ID}`);
        if (!r.ok) throw new Error('HTTP '+r.status);
        const user = await r.json();
        saldoAtual = Number(user.saldo ?? user.saldoAtual ?? 0);
        modoOffline = false;
      } catch {
        // fallback offline
        const salvo = localStorage.getItem(LS_KEY);
        saldoAtual = salvo ? Number(salvo) : 0;
        modoOffline = true;
      }
      renderSaldo();
    }

    async function adicionarSaldo(valor) {
      if (modoOffline) {
        // atualiza localmente
        saldoAtual = Number((saldoAtual + valor).toFixed(2));
        localStorage.setItem(LS_KEY, String(saldoAtual));
        renderSaldo();
        toastMsg('Saldo adicionado (modo offline).');
        return;
      }
      // tenta via API; se falhar, cai pra offline
      try {
        const r = await fetch(`${API_BASE}/usuarios/${USER_ID}/saldo`, {
          method:'PUT',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ valor })
        });
        if (!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        saldoAtual = Number(data.saldoAtual ?? data.saldo ?? (saldoAtual + valor));
        localStorage.setItem(LS_KEY, String(saldoAtual)); // mantém cache
        renderSaldo();
        toastMsg('Saldo adicionado com sucesso!');
      } catch {
        modoOffline = true;
        // faz local mesmo assim
        saldoAtual = Number((saldoAtual + valor).toFixed(2));
        localStorage.setItem(LS_KEY, String(saldoAtual));
        renderSaldo();
        toastMsg('API indisponível: aplicado localmente.', 'erro');
      }
    }

    // ===== Eventos UI =====
    window.addEventListener('DOMContentLoaded', carregarSaldo);

    toggleBtn.addEventListener('click', () => {
      saldoVisivel = !saldoVisivel;
      renderSaldo();
    });

    function abrirModal() {
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden','false');
      valorInput.value = '';
      erroValor.textContent = '';
      document.body.style.overflow = 'hidden';
      setTimeout(()=>valorInput.focus(),0);
    }
    function fecharModal() {
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      btnAdd.focus();
    }

    document.getElementById('btn-adicionar').addEventListener('click', abrirModal);
    document.getElementById('fechar-modal').addEventListener('click', fecharModal);
    document.getElementById('cancelar').addEventListener('click', fecharModal);
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) fecharModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && overlay.style.display==='flex') fecharModal(); });

    // máscara leve
    valorInput.addEventListener('input', () => {
      let v = valorInput.value.replace(/[^\d,.\s]/g,'').replace(/\s+/g,'');
      const partes = v.replace(',', '.').split('.');
      if (partes.length > 2) v = partes[0] + ',' + partes.slice(1).join('').replace(/[^\d]/g,'');
      else v = v.replace('.', ',');
      valorInput.value = v;
      erroValor.textContent = '';
    });

    // botões rápidos
    quickBtns.forEach(b => b.addEventListener('click', () => {
      const atual = parse(valorInput.value) || 0;
      valorInput.value = String((atual + Number(b.dataset.add)).toString().replace('.', ','));
      valorInput.dispatchEvent(new Event('input'));
    }));

    // confirmar
    btnConfirm.addEventListener('click', async () => {
      const num = parse(valorInput.value);
      if (Number.isNaN(num) || num <= 0) {
        erroValor.textContent = 'Digite um valor válido (ex.: 15,00).';
        valorInput.focus();
        toastMsg('Insira um valor válido!', 'erro');
        return;
      }
      if (num > 5000) {
        erroValor.textContent = 'Valor máximo: R$ 5.000,00.';
        valorInput.focus();
        toastMsg('Valor muito alto.', 'erro');
        return;
      }
      await adicionarSaldo(num);
      fecharModal();
    });
  </script>
</body>
</html>
