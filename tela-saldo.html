<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Minha Conta - CPTM</title>
  <link rel="stylesheet" href="./assets/css/tela-saldo.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
  <header class="header">
    <div class="top-row">
      <a class="link-back" href="home.html"><button class="back-button">←</button></a>
      <span class="title">CPTM</span>
      <img src="./assets/img/Logo cptm.png" alt="Logo CPTM" class="logo">
    </div>
    <div class="minha-conta">
        <h3>Minha Conta</h3>
    </div>
  </header>

  <main class="container">
    <section class="saldo-box">
      <p class="sub">Saldo atual</p>
      <div class="saldo">
        <span id="valor-saldo">R$ 14,70</span>
        <button id="toggle-saldo">
          <img id="icone-olho" src="./assets/img/eye-off.svg" alt="Ocultar saldo">
        </button>
      </div>
      <button class="adicionar-saldo">ADICIONAR SALDO</button>
    </section>

    <section class="acoes">
      <div class="card">
        <div class="info">
          <h3>Histórico</h3>
          <p>Acompanhe seus gastos de forma fácil e rápida.</p>
        </div>
        <img src="./assets/img/history-icon.svg" class="icon" alt="Ícone Histórico">
      </div>

      <div class="card">
        <div class="info">
          <h3>Gerar Bilhetes</h3>
          <p>Escolha o trajeto, pague pelo app e embarque com agilidade.</p>
        </div>
        <img src="./assets/img/tickets-icon.svg" class="icon" alt="Ícone Bilhete">
      </div>

      <div class="card">
        <div class="info">
          <h3>Carteira</h3>
          <p>Veja um bilhete já emitido disponível para utilização.</p>
        </div>
        <img src="./assets/img/wallet-icon.svg" class="icon" alt="Ícone Carteira">
      </div>
    </section>

    <div class="ajuda">
      <img src="./assets/img/help-icon.svg" alt="Ajuda" class="help-icon"> CENTRAL DE AJUDA
    </div>
  </main>

  <!-- Modal: Adicionar Saldo -->
  <div class="modal" id="modal-saldo" aria-hidden="true" role="dialog" aria-labelledby="modal-titulo">
    <div class="modal-backdrop" data-fecha-modal></div>
    <div class="modal-content" role="document">
      <button class="modal-close" id="fechar-modal" aria-label="Fechar">×</button>
      <h2 id="modal-titulo">Adicionar saldo</h2>

      <form id="form-adicionar-saldo">
        <label for="valor-adicionar">Valor (R$)</label>
        <input id="valor-adicionar" name="valor-adicionar" type="text" inputmode="decimal" placeholder="Ex.: 15,00" autocomplete="off" required>
        <p class="msg-erro" id="erro-valor" aria-live="polite"></p>
        <button type="submit" class="btn-confirmar">Adicionar</button>
      </form>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const BRL = Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const formatBRL = n => BRL.format(n);
    const parseBRLToNumber = t => {
      if (!t) return NaN;
      return Number(String(t).trim().replace(/[^\d,.-]/g, '').replace(/\.(?=\d{3}(,|$))/g, '').replace(',', '.'));
    };

    const valorSaldoEl = document.getElementById('valor-saldo');
    const iconeOlho = document.getElementById('icone-olho');
    const toggleBtn = document.getElementById('toggle-saldo');
    const btnAdicionar = document.querySelector('.adicionar-saldo');

    const modal = document.getElementById('modal-saldo');
    const fecharModalBtn = document.getElementById('fechar-modal');
    const backdrop = modal.querySelector('[data-fecha-modal]');
    const form = document.getElementById('form-adicionar-saldo');
    const inputValor = document.getElementById('valor-adicionar');
    const erroValor = document.getElementById('erro-valor');

    let saldoVisivel = true;
    let saldoAtual = (() => {
      const salvo = localStorage.getItem('saldoAtualReais');
      if (salvo !== null && !Number.isNaN(Number(salvo))) return Number(salvo);
      return parseBRLToNumber(valorSaldoEl.textContent);
    })();

    function renderSaldo() {
      valorSaldoEl.textContent = saldoVisivel ? formatBRL(saldoAtual) : '••••';
      iconeOlho.src = saldoVisivel ? './assets/img/eye-off.svg' : './assets/img/eye.svg';
      iconeOlho.alt = saldoVisivel ? 'Ocultar saldo' : 'Mostrar saldo';
    }
    renderSaldo();

    toggleBtn.addEventListener('click', () => {
      saldoVisivel = !saldoVisivel;
      renderSaldo();
    });

    function abrirModal() {
      modal.classList.add('aberto');
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden', 'false');
      inputValor.value = '';
      erroValor.textContent = '';
      document.body.style.overflow = 'hidden';
      setTimeout(() => inputValor.focus(), 0);
    }

    function fecharModal() {
      modal.classList.remove('aberto');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      btnAdicionar.focus();
    }

    btnAdicionar.addEventListener('click', abrirModal);
    fecharModalBtn.addEventListener('click', fecharModal);
    backdrop.addEventListener('click', fecharModal);
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && modal.classList.contains('aberto')) fecharModal();
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      const valorNum = parseBRLToNumber(inputValor.value);
      if (Number.isNaN(valorNum) || valorNum <= 0) {
        erroValor.textContent = 'Digite um valor válido (ex.: 15,00).';
        inputValor.focus();
        return;
      }
      if (valorNum > 5000) {
        erroValor.textContent = 'Por favor, insira um valor até R$ 5.000,00.';
        inputValor.focus();
        return;
      }

      saldoAtual = Number((saldoAtual + valorNum).toFixed(2));
      localStorage.setItem('saldoAtualReais', String(saldoAtual));
      renderSaldo();
      fecharModal();
    });

    inputValor.addEventListener('input', () => {
      let v = inputValor.value.replace(/[^\d,.\s]/g, '').replace(/\s+/g, '');
      const partes = v.replace(',', '.').split('.');
      if (partes.length > 2) {
        v = partes[0] + ',' + partes.slice(1).join('').replace(/[^\d]/g, '');
      } else {
        v = v.replace('.', ',');
      }
      inputValor.value = v;
      erroValor.textContent = '';
    });
  });
  </script>
</body>
</html>
